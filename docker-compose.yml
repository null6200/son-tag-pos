version: "3.9"
services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-pos_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      POSTGRES_DB: pos
    # SECURITY: Only expose to internal Docker network, not public internet
    # Remove or comment out 'ports' to prevent external access
    # ports:
    #   - "127.0.0.1:5433:5432"  # Uncomment ONLY if you need local access
    expose:
      - "5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - internal

  redis:
    image: redis:7-alpine
    # SECURITY: Redis with password authentication
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${REDIS_PASSWORD:?Set REDIS_PASSWORD in .env}"]
    # SECURITY: Only expose to internal Docker network
    # ports:
    #   - "127.0.0.1:6379:6379"  # Uncomment ONLY if you need local access
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    networks:
      - internal

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-pos_user}:${POSTGRES_PASSWORD}@postgres:5432/pos?schema=public
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - PORT=4000
      - JWT_SECRET=${JWT_SECRET:?Set JWT_SECRET in .env}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-https://stanfordelaze.com,https://son61.netlify.app}
    ports:
      - "4000:4000"
    depends_on:
      - postgres
      - redis
    networks:
      - internal

networks:
  internal:
    driver: bridge

volumes:
  pg_data:
  redis_data:
